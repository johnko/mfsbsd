#!/bin/sh
# Copyright (c) 2014 John Ko

PACKAGES="xf86-video-vesa xf86-video-fbdev xf86-input-mouse xf86-input-keyboard \
xineramaproto xinit xrdb xauth \
slim xfce xfce4-battery-plugin xfce4-bsdcpufreq-plugin xfce4-clipman-plugin \
xfce4-cpugraph-plugin xfce4-datetime-plugin xfce4-dict-plugin xfce4-diskperf-plugin \
xfce4-fsguard-plugin xfce4-genmon-plugin xfce4-minicmd-plugin xfce4-mount-plugin \
xfce4-netload-plugin xfce4-notification-daemon xfce4-print xfce4-quicklauncher-plugin \
xfce4-screenshooter-plugin xfce4-systemload-plugin xfce4-taskmanager xfce4-terminal \
xfce4-timer-plugin xfce4-volumed xfce4-weather-plugin xfce4-wm-themes xfce4-wmdock-plugin"

# Install ezjail if ezjail-admin doesn't exist and we have network
if [ ! -e /usr/local/bin/Xorg ]; then
	if /sbin/ifconfig | /usr/bin/grep status | /usr/bin/grep -v "no carrier" \
	| /usr/bin/grep . > /dev/null 2> /dev/null ; then
		for i in ${PACKAGES} ; do
			/usr/local/sbin/pkg-static install -y ${i}
		done
	fi
fi

# Exit if Xorg still doesn't exist
if [ ! -e /usr/local/bin/Xorg ]; then
	echo "Error: Xorg not found"; exit 1
fi

SERVICES="dbus hald slim"

for i in ${SERVICES} ; do
	/usr/sbin/sysrc -f /etc/rc.conf ${i}_enable=YES
done

if [ ! -e /etc/X11/xorg.conf ]; then
	/usr/local/bin/Xorg -configure
	/bin/mv ~/xorg.conf.new /etc/X11/xorg.conf
fi

if [ -e /etc/X11/xorg.conf ]; then
	if ! /usr/bin/egrep 'Option.*AutoAddDevices.*Off' /etc/X11/xorg.conf > /dev/null 2> /dev/null ; then
		echo 'Option "AutoAddDevices" "Off"' | /server/bin/insertafterfirst /etc/X11/xorg.conf ServerLayout
	fi
fi

if [ -e ~/.xinitrc ]; then
	/bin/chmod +x ~/.xinitrc
	/bin/chmod +x -h ~/.xinitrc
fi

for i in ${SERVICES} ; do
	/usr/sbin/service ${i} restart
done
