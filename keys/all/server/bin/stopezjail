#!/bin/sh
# Copyright (c) 2014 John Ko

if [ ! -e /usr/local/bin/ezjail-admin ]; then
	/usr/local/sbin/pkg-static install -y ezjail
fi

/usr/bin/sed -i '' 's#etc/fstab\.#usr/local/etc/ezjail/fstab.#' /usr/local/bin/ezjail-admin
/usr/bin/sed -i '' 's#ls -A | xargs#ls -A | egrep -v "(fstab\.|ezjail\.conf|\.sig$)" | xargs#' /usr/local/bin/ezjail-admin
/usr/bin/sed -i '' 's#ls | xargs rcorder#ls | egrep -v "(fstab\.|ezjail\.conf|\.sig$)" | xargs#' /usr/local/etc/rc.d/ezjail
if ! /usr/bin/grep '^ezjail_jailzfs="data/ezjail"' /usr/local/etc/ezjail.conf > /dev/null 2> /dev/null; then
	/bin/cat >/usr/local/etc/ezjail.conf <<EOF
ezjail_use_zfs="YES"
ezjail_use_zfs_for_jails="YES"
ezjail_jailzfs="data/ezjail"
EOF
fi

/usr/local/etc/rc.d/ezjail onestop
/bin/pkill ucarp
